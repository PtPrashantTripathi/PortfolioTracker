<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <canvas id="myChart" width="400" height="200"></canvas>
    <select id="interval">
        <option value="default">Default</option>
        <option value="yearly">Yearly</option>
        <option value="monthly">Monthly</option>
        <option value="weekly">Weekly</option>
    </select>

    <script type="module">
        import getData from "./test/get_data.js";

        // Get reference to chart holder DOM element
        const chartHolder = document.getElementById("myChart").getContext("2d");

        function createChart(data) {
            return new Chart(chartHolder, {
                type: "line",
                data: {
                    labels: data.map((d) => d.date),
                    datasets: [
                        {
                            label: "Market Value",
                            data: data.map((d) => d.close),
                            borderColor: "rgba(75, 192, 192, 1)",
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                        },
                        {
                            label: "Investment",
                            data: data.map((d) => d.holding),
                            borderColor: "rgba(153, 102, 255, 1)",
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "day",
                                tooltipFormat: "yyyy-MM-dd",
                            },
                            title: {
                                display: true,
                                text: "Date",
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: "Value",
                            },
                        },
                    },
                },
            });
        }

        function aggregateData(data, keyFunc) {
            return data.reduce((acc, current) => {
                const key = keyFunc(current.date);
                if (!acc[key] || current.date > acc[key].date) {
                    acc[key] = current;
                }
                return acc;
            }, {});
        }

        async function main() {
            try {
                // Fetch the data using getData
                const filePath = "../DATA/GOLD/HoldingsTrands/HoldingsTrands_data.csv";
                const raw_data = await getData(filePath);

                // Map data
                const data = raw_data.map((item) => ({
                    date: new Date(item.date),
                    holding: parseFloat(item.holding),
                    close: parseFloat(item.close),
                }));

                let chart = createChart(data);

                // Button Handlers for Aggregation
                document.getElementById("interval").addEventListener("change", (event) => {
                    const interval = event.target.value;
                    let updatedData = [];
                    switch (interval) {
                        case "yearly":
                            updatedData = Object.values(
                                aggregateData(data, (date) => date.getFullYear())
                            );
                            break;
                        case "monthly":
                            updatedData = Object.values(
                                aggregateData(data, (date) => date.getYearMonth())
                            );
                            break;
                        case "weekly":
                            updatedData = Object.values(
                                aggregateData(data, (date) => date.getYearWeek())
                            );
                            break;
                        default:
                            updatedData = data;
                    }
                    chart.destroy();
                    chart = createChart(updatedData);
                });
            } catch (error) {
                console.error("Error creating chart:", error);
            }
        }

        Date.prototype.getYearMonth = function () {
            const year = this.getFullYear();
            const month = (this.getMonth() + 1).toString().padStart(2, "0");
            return `${year}-${month}`;
        };

        Date.prototype.getYearWeek = function () {
            const dayMilliseconds = 86400000;

            const oneJan = new Date(this.getFullYear(), 0, 1);
            const oneJanDay = oneJan.getDay() || 7;
            const firstMondayTime = oneJan.getTime() + (8 - oneJanDay) * dayMilliseconds;

            const currentDate = new Date(
                this.getFullYear(),
                this.getMonth(),
                this.getDate()
            );
            const daysFromFirstMonday = Math.round(
                (currentDate - new Date(firstMondayTime)) / dayMilliseconds
            );

            let weekNum =
                daysFromFirstMonday >= 0 && daysFromFirstMonday < 364
                    ? Math.ceil((daysFromFirstMonday + 1) / 7)
                    : 52;

            if (daysFromFirstMonday < 0) {
                weekNum = 52;
            }

            return `${this.getFullYear()}-${weekNum.toString().padStart(2, "0")}`;
        };

        main();
    </script>
</body>
</html>
