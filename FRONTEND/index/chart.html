<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization with Chart.js</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
    <div class="text-center mb-4">
        <h1>Data Visualization with Chart.js</h1>
    </div>

    <div class="d-flex justify-content-center mb-4">
        <button id="yearly" class="btn btn-primary mx-2">Yearly</button>
        <button id="yearMonth" class="btn btn-secondary mx-2">Year-Month</button>
        <button id="yearWeek" class="btn btn-success mx-2">Year-Week</button>
    </div>

    <canvas id="myChart" style="height: 400px;"></canvas>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

    <script>
        function generateRandomData(startDate, endDate) {
            let data = [];
            let value = 1000;
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                value += Math.floor(Math.random() * 100) - 50;
                data.push({ date: new Date(currentDate).toISOString().split('T')[0], value: value });
                currentDate.setDate(currentDate.getDate() + 1); // Increment the date by 1 day
            }

            return data;
        }

        function getWeek(dateString) {
            let date = new Date(dateString);
            let dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            let yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            let weekNum = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return `${date.getUTCFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
        }

        function aggregateData(data, keyFunc) {
            return data.reduce((acc, current) => {
                let key = keyFunc(current.date);
                if (!acc[key] || current.date > acc[key].date) {
                    acc[key] = current;
                }
                return acc;
            }, {});
        }

        // Generate Data
        let start = new Date('2022-01-01');
        let end = new Date();
        let data = generateRandomData(start, end);

        // Initial Chart Configuration
        const ctx = document.getElementById('myChart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Value',
                    data: data.map(d => d.value),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'yyyy-MM-dd',
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });

        // Button Handlers for Aggregation
        document.getElementById("yearly").addEventListener("click", () => {
            const aggregatedData = Object.values(aggregateData(data, date => date.slice(0, 4)));
            updateChart(aggregatedData, "Yearly Data");
        });

        document.getElementById("yearMonth").addEventListener("click", () => {
            const aggregatedData = Object.values(aggregateData(data, date => date.slice(0, 7)));
            updateChart(aggregatedData, "Year-Month Data");
        });

        document.getElementById("yearWeek").addEventListener("click", () => {
            const aggregatedData = Object.values(aggregateData(data, getWeek));
            updateChart(aggregatedData, "Year-Week Data");
        });

        function updateChart(aggregatedData, title) {
            chart.data.labels = aggregatedData.map(d => d.date);
            chart.data.datasets[0].data = aggregatedData.map(d => d.value);
            chart.options.plugins.title = { display: true, text: title };
            chart.update();
        }
    </script>
</body>
</html>
